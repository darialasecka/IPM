<!DOCTYPE html>
<head>
  <style>
    div{
      padding: 20px;
    }
  </style>

  <script>
    // In the following line, you should include the prefixes of implementations you want to test.
    window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    // DON'T use "var indexedDB = ..." if you're not in a function.
    // Moreover, you may need references to some window.IDB* objects:
    window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"}; // This line should only be needed if it is needed to support the object's constants for older browsers
    window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
    // (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)

    if (!window.indexedDB) {
      window.alert("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
    }

    // Let us open our database
    var request = window.indexedDB.open("MyTestDatabase", 3);

    request.onerror = function(event) {
      // Do something with request.errorCode!
      alert("Couldn't open database");
    };
    request.onsuccess = function(event) {
      // Do something with request.result!
      db = event.target.result;

      db.onerror = function(event) {
        // Generic error handler for all errors targeted at this database's requests!
        alert("Database error: " + event.target.errorCode);
      };
    };

    request.onupgradeneeded = function(event) {
      // Save the IDBDatabase interface
      var db = event.target.result;

      // Create an objectStore for this database to hold info about our books.
      var objectStore = db.createObjectStore("contacts", { keyPath: "id" });

      objectStore.createIndex("name", "name", {unique:false});
      objectStore.createIndex("last_name", "last_name", {unique:false});
      objectStore.createIndex("phone_number", "phone_number", {unique:true});

      // Use transaction oncomplete to make sure the objectStore crration
      // is finished before adding data into it.
      objectStore.transaction.oncomplete = function(event) {

      };
    };

    document.getElementById('add').onclick = function(e) {
      var cname = document.getElementById('name').value;
      var clast_name = document.getElementById('last').value;
      var cphone_number = document.getElementById('phone_number').value;
      var cid = document.getElementById('id').value;

      const contact = {
        id: cid,
        name: cname,
        last_name: clast_name,
        phone_number: cphone_number
      }

      var transaction = db.transaction(["contacts"], "readwrite");
      transaction.oncomplete = function(event) {
        console.log("All done!");
      };

      transaction.onerror = function(event) {
        console.dir(event);
      };

      var contactssObjectStore = transaction.objectStore("contacts");
      var request = contactssObjectStore.add(contact);
      request.onsuccess = function(event) {
        console.log("Contact added successfully.");
      };

      updateTable();
    }

    document.getElementById('del').onclick = function(e){
      var del_id = document.getElementById('del_id').value;
      var request = db.transaction(["contacts"], "readwrite").objectStore("contacts").delete(del_id);

      request.onsuccess = function(event){
        console.log("Client " + del_id + " deleted.");
      }

      updateTable();
    }

    function updateTable(){

    document.getElementById("contacts_table").innerHTML = "";

    var request = db.transaction("contacts").objectStore("contacts").openCursor();

    request.onerror = function(event){
      console.dir(event);
    };

    request.onsuccess = function(event) {
      cursor = event.target.result;
      if(cursor) {
        document.getElementById("contacts_table").innerHTML += "<tr><td>" + cursor.value.name + "</td><td>"
          + cursor.value.author + "</td><td>" + cursor.value.year + "</td><td>" + cursor.key + "</td></tr>";

          cursor.continue();
      }
    };
  }
}

</script>
</head>

<body onload="init()">
  <div>
    <form id="add_contact">
      <label for="id"> Id: </label>
      <input type="number" id="id" name="id" min="0" required/> </br> </br>

      <label for="name"> First name: </label>
      <input type="text" id="name" name="name" required/> </br> </br>

      <label for="last"> Last name: </label>
      <input type="text" id="last" name="last" required/> </br> </br>

      <label for="phone_number"> Phone number: </label>
      <input type="text" id="phone_number" name="phone_number" pattern="[0-9]{9}$"  placeholder="123123123" required/> </br> </br>

      <button id="add" name="add">Add contact</button>
    </form>
  </div>

  <div style="border-color : red;">
    <form id="del_contact">
      <label for="del_id"> Id: </label>
      <input type="number" id="del_id" name="del_id min="0" required/> </br> </br>

      <button id="del" name="del">Delete contact</button>
    </form>
  </div>

  <table id="contacts">
    <thead>
    <tr><th>Id</th><th>Name</th><th>Last name</th><th>Phone number</th></tr>
    </thead>
    <tbody id="contacts_table">
    </tbody>
  </table>

</body>
</html>

